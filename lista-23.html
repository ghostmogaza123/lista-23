<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سجل النقدية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- الشريط العلوي -->
            <div class="bg-blue-600 text-white p-4">
                <h1 class="text-2xl font-bold text-center">سجل النقدية</h1>
            </div>

            <!-- المحتوى الرئيسي -->
            <div class="p-4">
                <!-- نموذج الإدخال -->
                <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="item" class="block text-sm font-medium text-gray-700 mb-1">الصنف</label>
                            <input type="text" id="item" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="أدخل اسم الصنف">
                        </div>
                        <div>
                            <label for="price" class="block text-sm font-medium text-gray-700 mb-1">السعر</label>
                            <input type="number" id="price" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="أدخل السعر">
                        </div>
                        <div class="flex items-end">
                            <button id="addBtn" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition duration-200">
                                <i class="fas fa-plus mr-2"></i>إضافة
                            </button>
                        </div>
                    </div>
                </div>

                <!-- حاويات المحتوى -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- قائمة المنتجات -->
                    <div class="lg:col-span-2">
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <div class="bg-gray-50 p-3 border-b border-gray-200">
                                <h2 class="font-semibold text-lg">المنتجات المضافة</h2>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">م</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">الصنف</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">السعر</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemsList" class="bg-white divide-y divide-gray-200">
                                        <!-- سيتم ملؤها بالبيانات -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="bg-gray-50 p-3 border-t border-gray-200 flex justify-between items-center">
                                <span class="font-medium">الإجمالي:</span>
                                <span id="totalAmount" class="font-bold text-lg">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- سجل العمليات -->
                    <div>
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden h-full">
                            <div class="bg-gray-50 p-3 border-b border-gray-200">
                                <div class="flex justify-between items-center">
                                    <h2 class="font-semibold text-lg">سجل العمليات</h2>
                                    <button id="newTransactionBtn" class="text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                                        <i class="fas fa-plus mr-1"></i>فتح معاملة جديدة
                                    </button>
                                </div>
                            </div>
                            <div class="p-3 overflow-y-auto" style="max-height: 500px;">
                                <ul id="transactionsHistory" class="space-y-2">
                                    <!-- سيتم ملؤها بالبيانات -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // تحديد عناصر DOM
        const itemInput = document.getElementById('item');
        const priceInput = document.getElementById('price');
        const addBtn = document.getElementById('addBtn');
        const itemsList = document.getElementById('itemsList');
        const totalAmount = document.getElementById('totalAmount');
        const transactionsHistory = document.getElementById('transactionsHistory');

        // تحميل البيانات من localStorage عند بدء التشغيل
        window.addEventListener('DOMContentLoaded', () => {
            loadItems();
            loadTransactions();
            
            document.getElementById('newTransactionBtn').addEventListener('click', () => {
                if (getItems().length > 0) {
                    addTransaction();
                } else {
                    alert('لا توجد أصناف مضافة لإنشاء معاملة جديدة');
                }
            });
            
            // Event delegation for transaction delete buttons
            transactionsHistory.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-transaction-btn') || 
                    e.target.parentElement.classList.contains('delete-transaction-btn')) {
                    const btn = e.target.classList.contains('delete-transaction-btn') ? e.target : e.target.parentElement;
                    const id = btn.dataset.id;
                    deleteTransaction(id);
                }
            });
        });

        // إضافة عنصر جديد
        addBtn.addEventListener('click', addItem);

        // استدعاء وظيفة الإضافة عند الضغط على Enter
        itemInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addItem();
            }
        });

        priceInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addItem();
            }
        });

        // وظيفة إضافة عنصر
        function addItem() {
            const item = itemInput.value.trim();
            const price = parseFloat(priceInput.value);

            if (!item || isNaN(price) || price <= 0) {
                alert('الرجاء إدخال صنف وسعر صحيح');
                return;
            }

            // إنشاء معرف فريد للعنصر
            const id = Date.now();

            // إنشاء كائن العنصر
            const newItem = {
                id,
                item,
                price
            };

            // حفظ العنصر
            saveItem(newItem);

            // عرض العنصر
            displayItem(newItem);

            // تحديث الإجمالي
            updateTotal();

            // إضافة إلى سجل العمليات إذا كانت هذه هي المرة الأولى
            // No automatic transaction creation

            // مسح حقول الإدخال
            itemInput.value = '';
            priceInput.value = '';
            itemInput.focus();
        }

        // وظيفة حفظ العنصر
        function saveItem(item) {
            let items = getItems();
            items.push(item);
            localStorage.setItem('cashRegisterItems', JSON.stringify(items));
        }

        // وظيفة الحصول على العناصر
        function getItems() {
            const items = localStorage.getItem('cashRegisterItems');
            return items ? JSON.parse(items) : [];
        }

        // وظيفة تحميل العناصر
        function loadItems() {
            const items = getItems();
            items.forEach(item => displayItem(item));
            updateTotal();
        }

        // وظيفة عرض العنصر
        function displayItem(item) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.dataset.id = item.id;
            row.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${itemsList.children.length + 1}</td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <input type="text" value="${item.item}" class="item-input w-full border-0 bg-transparent" data-id="${item.id}">
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <input type="number" value="${item.price}" class="price-input w-full border-0 bg-transparent" data-id="${item.id}">
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                    <button class="delete-btn text-red-600 hover:text-red-900" data-id="${item.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            itemsList.appendChild(row);

            // إضافة مستمعي الأحداث لحقول الإدخال
            const itemInput = row.querySelector('.item-input');
            const priceInput = row.querySelector('.price-input');
            const deleteBtn = row.querySelector('.delete-btn');

            itemInput.addEventListener('change', () => updateItem(item.id, 'item', itemInput.value));
            priceInput.addEventListener('change', () => {
                const newPrice = parseFloat(priceInput.value);
                if (!isNaN(newPrice) && newPrice > 0) {
                    updateItem(item.id, 'price', newPrice);
                } else {
                    priceInput.value = item.price;
                }
            });
            deleteBtn.addEventListener('click', () => deleteItem(item.id));
        }

        // وظيفة تعديل العنصر
        function updateItem(id, field, value) {
            let items = getItems();
            const itemIndex = items.findIndex(item => item.id == id);
            if (itemIndex !== -1) {
                items[itemIndex][field] = value;
                localStorage.setItem('cashRegisterItems', JSON.stringify(items));
                updateTotal();
            }
        }

        // وظيفة حذف العنصر
        function deleteItem(id) {
            if (confirm('هل أنت متأكد من حذف هذا العنصر؟')) {
                let items = getItems();
                items = items.filter(item => item.id != id);
                localStorage.setItem('cashRegisterItems', JSON.stringify(items));
                
                // إزالة الصف من الواجهة
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (row) row.remove();
                
                // إعادة ترقيم العناصر
                const rows = itemsList.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    row.cells[0].textContent = index + 1;
                });
                
                updateTotal();
            }
        }

        // وظيفة تحديث الإجمالي
        function updateTotal() {
            const items = getItems();
            const total = items.reduce((sum, item) => sum + item.price, 0);
            totalAmount.textContent = total.toFixed(2);
        }

        // وظائف إدارة سجل العمليات
        function addTransaction() {
            const transactionId = Date.now();
            const transactionDate = new Date().toLocaleString('ar-EG', {
                day: 'numeric',
                month: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            localStorage.setItem('currentTransaction', transactionId);
            
            const transaction = {
                id: transactionId,
                date: transactionDate,
                items: getItems()
            };
            
            saveTransaction(transaction);
        }

        function saveTransaction(transaction) {
            let transactions = getTransactions();
            transactions.push(transaction);
            localStorage.setItem('cashRegisterTransactions', JSON.stringify(transactions));
            displayTransaction(transaction);
            
            // مسح العناصر الحالية
            localStorage.removeItem('cashRegisterItems');
            itemsList.innerHTML = '';
            totalAmount.textContent = '0';
            localStorage.removeItem('currentTransaction');
        }

        function getTransactions() {
            const transactions = localStorage.getItem('cashRegisterTransactions');
            return transactions ? JSON.parse(transactions) : [];
        }

        function loadTransactions() {
            const transactions = getTransactions();
            transactions.forEach(transaction => displayTransaction(transaction));
        }

        function displayTransaction(transaction) {
            const total = transaction.items.reduce((sum, item) => sum + item.price, 0);
            
            const li = document.createElement('li');
            li.className = 'bg-gray-50 p-3 rounded-lg';
            li.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium">${transaction.date}</span>
                    <div class="flex space-x-2 space-x-reverse">
                        <button class="view-btn text-blue-600 hover:text-blue-800" data-id="${transaction.id}">
                            <i class="fas fa-eye"></i> عرض
                        </button>
                        <button class="delete-transaction-btn text-red-600 hover:text-red-800" data-id="${transaction.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="text-sm">
                    <div class="flex justify-between mb-1">
                        <span>عدد الأصناف:</span>
                        <span>${transaction.items.length}</span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span>الإجمالي:</span>
                        <span class="font-medium">${total.toFixed(2)}</span>
                    </div>
                </div>
            `;
            transactionsHistory.insertBefore(li, transactionsHistory.firstChild);
            
            // إضافة مستمع الحدث لزر العرض
            const viewBtn = li.querySelector('.view-btn');
            viewBtn.addEventListener('click', () => viewTransaction(transaction.id));
        }

        function deleteTransaction(id) {
            if (confirm('هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن استرجاعها بعد الحذف.')) {
                let transactions = getTransactions();
                transactions = transactions.filter(t => t.id != id);
                localStorage.setItem('cashRegisterTransactions', JSON.stringify(transactions));
                
                // Reload transactions list
                transactionsHistory.innerHTML = '';
                loadTransactions();
                
                // If the deleted transaction was being viewed, clear the items list
                if (localStorage.getItem('currentTransaction') == id) {
                    localStorage.removeItem('currentTransaction');
                    localStorage.removeItem('cashRegisterItems');
                    itemsList.innerHTML = '';
                    totalAmount.textContent = '0';
                }
            }
        }

        function viewTransaction(id) {
            const transactions = getTransactions();
            const transaction = transactions.find(t => t.id == id);
            if (transaction) {
                // مسح العناصر الحالية
                itemsList.innerHTML = '';
                localStorage.removeItem('cashRegisterItems');
                
                // عرض العناصر المعروضة
                transaction.items.forEach(item => displayItem(item));
                updateTotal();
                
                // حفظ المعاملة الحالية
                localStorage.setItem('currentTransaction', transaction.id);
            }
        }
    </script>
</body>
</html>

